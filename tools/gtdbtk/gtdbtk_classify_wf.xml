<tool id="gtdbtk_classify_wf" name="GTDB-Tk classify_wf" version="@TOOL_VERSION@+galaxy0" python_template_version="3.5">

  <!-- THIS HAS BEEN SUPERCEDED BY https://github.com/galaxyproject/tools-iuc/tree/master/tools/gtdbtk -->

    <description>Determine taxonomic classification of genomes</description>

    <macros>
        <token name="@TOOL_VERSION@">2.1.0</token>
        <token name="@VERSION_SUFFIX@">0</token>
    </macros>

    <requirements>
        <requirement type="package" version="@TOOL_VERSION@">gtdbtk</requirement>
    </requirements>

    <command detect_errors="exit_code"><![CDATA[

## Configure input variables
## ---------------------------------------------------------------------

#set INPUT_DIR = 'input_genomes'
#set $OUTPUT_DIR = 'gtdbtk_out'

#if $input_genomes[0].is_of_type('fasta.gz'):
#set EXTENSION = 'gz'
#else
#set EXTENSION = 'fa'
#end if

## Format collection as directory
## ---------------------------------------------------------------------

&& mkdir $INPUT_DIR
#for $i, $file in enumerate($input_genomes):
    #if EXTENSION == 'fa':
    && ln -s '$file' $INPUT_DIR/genome_${i}.fasta
    #else
    && ln -s '$file' $INPUT_DIR/genome_${i}.fasta.gz
    #end if
#end for

## Run GTDB-Tk classify
## ---------------------------------------------------------------------

&& gtdbtk classify_wf
  --genome_dir $INPUT_DIR
  --out_dir $OUTPUT_DIR
  --extension $EXTENSION
  --cpus \${GALAXY_SLOTS:-2}

    ]]></command>

    <inputs>
        <param type="data_collection" name="input_genomes" label="Genomes to annotate"
          help="A collection of genomes in FASTA format to be classified by GTDB-Tk" format="fasta,fasta.gz"/>
    </inputs>

    <outputs>
      <!-- Standard outputs -->
      <collection name="classify_tree" type="list:list" label="${tool.name} on ${on_string}: Classification trees">
        <discover_datasets
          pattern="gtdbtk\.(?P&lt;designation&gt;.+)\.classify\.tree"
          directory="gtdbtk_out/classify"
          format="newick"
          visible="true"
        />
      </collection>
      <collection name="classify_summary" type="list:list" label="${tool.name} on ${on_string}: Classification summary">
        <discover_datasets
          pattern="gtdbtk\.(?P&lt;designation&gt;.+)\.summary\.tsv"
          directory="gtdbtk_out/classify"
          format="tabular"
          visible="true"
        />
      </collection>
      <data
        name="failed_genomes"
        format="tabular"
        label="${tool.name} on ${on_string}: failed genomes"
        from_work_dir="gtdbtk_out/identify/gtdbtk.failed_genomes.tsv"
      />

      <!-- Optional -->
      <data
        name="gtdbtk_log"
        format="txt"
        label="${tool.name} on ${on_string}: GTDB-Tk log file"
        from_work_dir="gtdbtk_out/gtdbtk.log"
      />
      <data
        name="gtdbtk_warnings"
        format="txt"
        label="${tool.name} on ${on_string}: GTDB-Tk warnings"
        from_work_dir="gtdbtk_out/gtdbtk.warnings.log"
      />

      <!-- Optional: align -->
      <collection name="align_msa_fasta" type="list:list" label="${tool.name} on ${on_string}: Aligned MSA">
        <discover_datasets
          pattern="gtdbtk\.(?P&lt;designation&gt;.+)\.msa\.fasta.gz"
          directory="gtdbtk_out/align"
          format="fasta.gz"
          visible="true"
        />
      </collection>
      <collection name="align_user_msa_fasta" type="list:list" label="${tool.name} on ${on_string}: Aligned user MSA">
        <discover_datasets
          pattern="gtdbtk\.(?P&lt;designation&gt;.+)\.user_msa\.fasta.gz"
          directory="gtdbtk_out/align"
          format="fasta.gz"
          visible="true"
        />
      </collection>
      <collection name="align_msa_filtered" type="list:list" label="${tool.name} on ${on_string}: Aligned MSA - filtered">
        <discover_datasets
          pattern="gtdbtk\.(?P&lt;designation&gt;.+)\.filtered\.tsv"
          directory="gtdbtk_out/align"
          format="tabular"
          visible="true"
        />
      </collection>

      <!-- Optional: identify -->
      <data
        name="align_translation_table"
        type="tabular"
        label="${tool.name} on ${on_string}: translation summary table"
        from_work_dir="identify/gtdbtk.translation_table_summary.tsv"
      >
      </data>
      <collection name="marker_genes" type="list:list" label="${tool.name} on ${on_string}: Marker genes summary">
        <discover_datasets
          pattern="gtdbtk\.(?P&lt;designation&gt;.+)markers_summary\.tsv"
          directory="gtdbtk_out/identify"
          format="tabular"
          visible="true"
        />
      </collection>
    </outputs>

    <tests>
        <test>
            <param name="input_genomes">
                <collection type="list">
                    <element name="item1" value="genome_1.fasta.gz"/>
                    <element name="item2" value="genome_2.fasta.gz"/>
                    <element name="item3" value="genome_3.fasta.gz"/>
                </collection>
            </param>
            <output name="classify_summary">
              <discovered_dataset
                designation="ar53"
                ftype="tabular"
                file="classify/gtdbtk.ar53.summary.tsv"
              />
            </output>
            <output name="classify_tree">
              <discovered_dataset
                designation="ar53"
                ftype="newick"
                file="classify/gtdbtk.ar53.classify.tree"
              />
            </output>
        </test>
    </tests>
    <help><![CDATA[
      TODO
    ]]></help>
    <citations>
        <citation type="doi">10.1093/bioinformatics/btz848</citation>
    </citations>
</tool>
